name: DevSecOps Security & Deployment Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security-and-deploy:
    name: Security Scan + AI Analysis + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Run npm audit (JSON for AI + HTML for printing)
      - name: Generate npm Audit Reports
        run: |
          npm install -g npm-audit-html jq
          npm audit --json > audit.json || true
          npm-audit-html -i audit.json -o security-report.html

      # 5Ô∏è‚É£ Install and Run Snyk
      - name: Install Snyk
        run: npm install -g snyk

      - name: Run Snyk Test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > snyk-report.json || true

      # 6Ô∏è‚É£ Combine Security Reports for AI
      - name: Prepare Combined Security Data
        run: |
          jq -s '{npm_audit: .[0], snyk: .[1]}' audit.json snyk-report.json > combined-security.json

      # 7Ô∏è‚É£ ü§ñ AI Security Analysis (Markdown formatted)
      - name: Run AI Security Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @- <<EOF
          {
            "model": "gpt-4o-mini",
            "messages": [
              {
                "role": "system",
                "content": "You are a senior DevSecOps security analyst. Analyze the provided security scan results and produce a professional Markdown formatted security report. Use clear sections with headings (##), bullet points, and short explanations. Include: 1) Executive Summary, 2) Overall Risk Level (Low/Medium/High/Critical), 3) Top Vulnerabilities, 4) Remediation Plan, 5) Deployment Recommendation. Do NOT return JSON."
              },
              {
                "role": "user",
                "content": "$(cat combined-security.json | sed 's/"/\\"/g')"
              }
            ],
            "temperature": 0.2
          }
          EOF
          )

          echo "$RESPONSE" > ai-response.json
          jq -r '.choices[0].message.content' ai-response.json > ai-report.md

      # 8Ô∏è‚É£ Publish AI Report to GitHub Summary (Clean Markdown)
      - name: Publish AI Security Report
        run: |
          echo "## ü§ñ AI Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ai-report.md >> $GITHUB_STEP_SUMMARY

      # 9Ô∏è‚É£ Upload Printable & AI Reports
      - name: Upload Security Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-report.html
            audit.json
            snyk-report.json
            ai-report.md

      # üîü Deploy to Vercel (Only on main branch)
      - name: üöÄ Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        run: |
          npm install -g vercel
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
