name: DevSecOps Security & Deployment Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security-and-deploy:
    name: Security Scan + AI + Secret Scan + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 50

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3Ô∏è‚É£ Install project dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Install system tools
      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wkhtmltopdf

      # ===============================
      # 5Ô∏è‚É£ npm Audit
      # ===============================
      - name: Generate npm Audit Report
        run: |
          npm install -g npm-audit-html
          npm audit --json > audit.json || true
          npm-audit-html -i audit.json -o npm-audit-report.html
          wkhtmltopdf --enable-local-file-access npm-audit-report.html npm-audit-report.pdf

      # ===============================
      # 6Ô∏è‚É£ Snyk Scan
      # ===============================
      - name: Install Snyk
        run: npm install -g snyk

      - name: Run Snyk Test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > snyk.json || true

      - name: Convert Snyk JSON to Styled HTML + PDF
        run: |
          cat <<EOF > snyk-report.html
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Snyk Security Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 5px; }
              .critical { color: #b91c1c; font-weight: bold; }
              .high { color: #dc2626; font-weight: bold; }
              .medium { color: #d97706; font-weight: bold; }
              .low { color: #059669; font-weight: bold; }
              ul { margin-left: 20px; }
            </style>
          </head>
          <body>
            <h1>Snyk Security Report</h1>
            <ul>
EOF
          cat snyk.json | jq -r '.vulnerabilities[]? | "<li class=\"\(.severity)\">Package: \(.packageName), Severity: \(.severity), CVE: \(.identifiers.CVE[0] // "N/A"), Path: \(.from | join(" ‚Üí "))</li>"' >> snyk-report.html
          echo "</ul></body></html>" >> snyk-report.html
          wkhtmltopdf --enable-local-file-access snyk-report.html snyk-report.pdf

      # ===============================
      # 7Ô∏è‚É£ Secret Scan (Gitleaks)
      # ===============================
      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks-linux-amd64.tar.gz | tar xz
          chmod +x gitleaks

      - name: Run Gitleaks Scan
        run: |
          ./gitleaks detect --source=. --report-format=json --report-path=gitleaks.json || true
          ./gitleaks detect --source=. --report-format=html --report-path=gitleaks.html || true
          wkhtmltopdf --enable-local-file-access gitleaks.html gitleaks.pdf

      # ===============================
      # 8Ô∏è‚É£ Combine Reports for AI
      # ===============================
      - name: Combine Security Data
        run: |
          jq -s '{npm_audit: .[0], snyk: .[1], secrets: .[2]}' audit.json snyk.json gitleaks.json > combined-security.json

      # ===============================
      # 9Ô∏è‚É£ Run AI Analysis (Fixed YAML)
      # ===============================
      - name: Run AI Security Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @- <<'EOF'
{
  "model": "gpt-4o-mini",
  "messages": [
    {
      "role": "system",
      "content": "You are a senior DevSecOps security analyst. Analyze the combined npm, Snyk, and Gitleaks scans. Generate a human-readable HTML report with these rules: 
1) Use headings, bullet points, and readable paragraphs.
2) Explicitly say 'No vulnerabilities found' if nothing is detected.
3) Highlight severity with colors.
4) Include package, CVE, file path, and remediation instructions."
    },
    {
      "role": "user",
      "content": "$(cat combined-security.json | sed 's/"/\\"/g')"
    }
  ],
  "temperature": 0.2
}
EOF
          )

          echo "$RESPONSE" > ai-body.html

      - name: Generate Styled AI HTML + PDF
        run: |
          cat <<EOF > ai-security-report.html
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>AI Security Executive Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 5px; }
              h2 { color: #1f2937; margin-top: 25px; }
              .critical { color: #b91c1c; font-weight: bold; }
              .high { color: #dc2626; font-weight: bold; }
              .medium { color: #d97706; font-weight: bold; }
              .low { color: #059669; font-weight: bold; }
              ul { margin-left: 20px; }
            </style>
          </head>
          <body>
            <h1>AI Security Executive Report</h1>
            $(cat ai-body.html)
          </body>
          </html>
          EOF

          wkhtmltopdf --enable-local-file-access ai-security-report.html ai-security-report.pdf

      # ===============================
      # üîü Upload All PDF Reports
      # ===============================
      - name: Upload All Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-pdf-reports
          path: |
            npm-audit-report.pdf
            snyk-report.pdf
            gitleaks.pdf
            ai-security-report.pdf

      # ===============================
      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy to Vercel
      # ===============================
      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        run: |
          npm install -g vercel
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
