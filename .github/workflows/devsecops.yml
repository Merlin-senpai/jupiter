name: DevSecOps Security & Deployment Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security-and-deploy:
    name: Security Scan + AI Analysis + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Run npm audit
      - name: Run npm audit
        run: |
          npm audit --json > audit.json || true

      # 5Ô∏è‚É£ Install Snyk
      - name: Install Snyk
        run: npm install -g snyk

      - name: Run Snyk Test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > snyk-report.json || true

      # 6Ô∏è‚É£ ü§ñ AI Security Analysis
      - name: AI Security Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Preparing combined security data..."

          jq -s '{npm_audit: .[0], snyk: .[1]}' audit.json snyk-report.json > combined-security.json

          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @- <<EOF
          {
            "model": "gpt-4o-mini",
            "messages": [
              {
                "role": "system",
                "content": "You are a senior DevSecOps security analyst. Analyze the provided security scan results and produce a professional structured security report with: 1) Executive Summary, 2) Overall Risk Level (Low/Medium/High/Critical), 3) Top 5 vulnerabilities, 4) Recommended Remediation Plan, 5) Deployment recommendation (Allow or Block)."
              },
              {
                "role": "user",
                "content": "$(cat combined-security.json | sed 's/"/\\"/g')"
              }
            ],
            "temperature": 0.2
          }
          EOF
          )

          echo "$RESPONSE" > ai-response.json

          jq -r '.choices[0].message.content' ai-response.json > ai-report.txt

      # 7Ô∏è‚É£ Publish AI Report to GitHub Summary (Chat-style)
      - name: Publish AI Report
        run: |
          echo "## ü§ñ AI Security Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ai-report.txt >> $GITHUB_STEP_SUMMARY

      # 8Ô∏è‚É£ Upload Raw Reports
      - name: Upload Security Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            audit.json
            snyk-report.json
            ai-report.txt

      # 9Ô∏è‚É£ üöÄ Deploy to Vercel
      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        run: |
          npm install -g vercel
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
