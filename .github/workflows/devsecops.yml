name: DevSecOps Security Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security-and-deploy:
    name: Security Scan + PDF + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wkhtmltopdf poppler-utils

      # npm Audit
      - name: npm Audit PDF
        run: |
          npm install -g npm-audit-html
          npm audit --json > audit.json || true
          npm-audit-html -i audit.json -o npm-audit-report.html
          wkhtmltopdf --enable-local-file-access npm-audit-report.html npm-audit-report.pdf

      # Snyk
      - name: Install Snyk
        run: npm install -g snyk

      - name: Run Snyk Test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --json > snyk-report.json || true

      - name: Convert Snyk JSON to PDF
        run: |
          cat <<EOF > snyk-report.html
          <!DOCTYPE html>
          <html>
          <head><meta charset="UTF-8"><title>Snyk Report</title></head>
          <body><h1>Snyk Report</h1></body></html>
          EOF
          wkhtmltopdf --enable-local-file-access snyk-report.html snyk-report.pdf

      # Merge PDFs
      - name: Merge PDFs
        run: |
          echo "<html><body><h1>Security Audit</h1></body></html>" > cover.html
          wkhtmltopdf cover.html cover.pdf
          pdfunite cover.pdf npm-audit-report.pdf snyk-report.pdf unified-security-report.pdf

      - name: Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: unified-security-report
          path: unified-security-report.pdf

      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        run: |
          npm install -g vercel
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
