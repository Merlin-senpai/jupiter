name: DevSecOps Security & Deployment Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  security-and-deploy:
    name: Security Scan + AI Analysis + Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Install required system tools
      - name: Install system tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wkhtmltopdf

      # 5Ô∏è‚É£ Generate npm audit (JSON + HTML)
      - name: Generate npm Audit Reports
        run: |
          npm install -g npm-audit-html
          npm audit --json > audit.json || true
          npm-audit-html -i audit.json -o npm-audit-report.html

      # Convert npm HTML to PDF
      - name: Convert npm report to PDF
        run: |
          wkhtmltopdf npm-audit-report.html npm-audit-report.pdf

      # 6Ô∏è‚É£ Install and run Snyk
      - name: Install Snyk
        run: npm install -g snyk

      - name: Run Snyk Test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --json > snyk-report.json || true
          snyk test --severity-threshold=low > snyk-readable.txt || true

      # Convert Snyk text output to PDF
      - name: Convert Snyk report to PDF
        run: |
          echo "<pre>" > snyk-report.html
          cat snyk-readable.txt >> snyk-report.html
          echo "</pre>" >> snyk-report.html
          wkhtmltopdf snyk-report.html snyk-report.pdf

      # 7Ô∏è‚É£ Combine Security Data for AI
      - name: Prepare Combined Security Data
        run: |
          jq -s '{npm_audit: .[0], snyk: .[1]}' audit.json snyk-report.json > combined-security.json

      # 8Ô∏è‚É£ Run AI Security Analysis
      - name: Run AI Security Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -s \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @- <<EOF
          {
            "model": "gpt-4o-mini",
            "messages": [
              {
                "role": "system",
                "content": "You are a senior DevSecOps security analyst. Analyze the provided scan results and generate a professional structured security report in clear Markdown format. Include file names, affected packages, severity levels, CVE identifiers (if present), and remediation steps. Provide precise technical details."
              },
              {
                "role": "user",
                "content": "$(cat combined-security.json | sed 's/"/\\"/g')"
              }
            ],
            "temperature": 0.2
          }
          EOF
          )

          echo "$RESPONSE" > ai-response.json
          jq -r '.choices[0].message.content' ai-response.json > ai-report.md

      # Convert AI Markdown to PDF
      - name: Convert AI Report to PDF
        run: |
          echo "<pre>" > ai-report.html
          cat ai-report.md >> ai-report.html
          echo "</pre>" >> ai-report.html
          wkhtmltopdf ai-report.html ai-security-report.pdf

      # 9Ô∏è‚É£ Upload All PDF Reports
      - name: Upload Security PDF Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-pdf-reports
          path: |
            npm-audit-report.pdf
            snyk-report.pdf
            ai-security-report.pdf

      # üîü Deploy to Vercel
      - name: üöÄ Deploy to Vercel
        if: github.ref == 'refs/heads/main'
        run: |
          npm install -g vercel
          vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
